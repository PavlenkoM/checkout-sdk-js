import{getScriptLoader as t}from"@bigcommerce/script-loader";import{includes as e,isEmpty as i,omitBy as n,round as r,some as o}from"lodash";var s,a,d={};function l(t,e){return Object.assign(t,{resolveIds:e})}d.d=(t,e)=>{for(var i in e)d.o(e,i)&&!d.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},d.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);class c extends Error{constructor(t){var e;super(t||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",e=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,e):this.__proto__=e,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class h extends c{constructor(t){super(t||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class u extends h{constructor(t){let e="Unable to submit payment for the order because the payload is invalid.";t&&(e=`${e} Make sure the following fields are provided correctly: ${t.join(", ")}.`),super(e),this.name="PaymentArgumentInvalidError"}}function p(t){return!("object"!=typeof t||null===t||void 0!==t.shouldSaveInstrument&&"boolean"!=typeof t.shouldSaveInstrument||void 0!==t.shouldSetAsDefaultInstrument&&"boolean"!=typeof t.shouldSetAsDefaultInstrument)}function m(t){return Boolean(t.instrumentId)}!function(t){t[t.MissingBillingAddress=0]="MissingBillingAddress",t[t.MissingCart=1]="MissingCart",t[t.MissingCheckout=2]="MissingCheckout",t[t.MissingConsignments=3]="MissingConsignments",t[t.MissingCustomer=4]="MissingCustomer",t[t.MissingCheckoutConfig=5]="MissingCheckoutConfig",t[t.MissingOrder=6]="MissingOrder",t[t.MissingOrderConfig=7]="MissingOrderConfig",t[t.MissingOrderId=8]="MissingOrderId",t[t.MissingPayment=9]="MissingPayment",t[t.MissingPaymentId=10]="MissingPaymentId",t[t.MissingPaymentInstrument=11]="MissingPaymentInstrument",t[t.MissingPaymentMethod=12]="MissingPaymentMethod",t[t.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",t[t.MissingPaymentStatus=14]="MissingPaymentStatus",t[t.MissingPaymentToken=15]="MissingPaymentToken",t[t.MissingShippingAddress=16]="MissingShippingAddress"}(s||(s={}));class y extends c{constructor(t){super(function(t){switch(t){case s.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case s.MissingCart:return"Unable to proceed because cart data is unavailable.";case s.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case s.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case s.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case s.MissingCheckoutConfig:case s.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case s.MissingOrder:return"Unable to proceed because order data is unavailable.";case s.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case s.MissingPayment:return"Unable to proceed because payment data is unavailable.";case s.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case s.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case s.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(t)),this.subtype=t,this.name="MissingDataError",this.type="missing_data"}}class g extends c{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}!function(t){t[t.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",t[t.CustomerNotInitialized=1]="CustomerNotInitialized",t[t.PaymentNotInitialized=2]="PaymentNotInitialized",t[t.ShippingNotInitialized=3]="ShippingNotInitialized",t[t.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(a||(a={}));class v extends c{constructor(t){super(function(t){switch(t){case a.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case a.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case a.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case a.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(t)),this.subtype=t,this.name="NotInitializedError",this.type="not_initialized"}}const S=t=>"object"==typeof t&&null!==t&&"body"in t;class f extends c{constructor(t){super(t||"Payment process was cancelled."),this.name="PaymentMethodCancelledError",this.type="payment_cancelled"}}function _(t){return null!==t&&"object"==typeof t&&"cardNumberElementOptions"in t&&"cardCvcElementOptions"in t&&"cardExpiryElementOptions"in t&&void 0!==t.cardNumberElementOptions&&void 0!==t.cardCvcElementOptions&&void 0!==t.cardExpiryElementOptions}var I,C,E,P;!function(t){t.Solid="solid",t.Default="default"}(I||(I={})),function(t){t.Alipay="alipay",t.CardCvc="cardCvc",t.CardExpiry="cardExpiry",t.CardNumber="cardNumber",t.CreditCard="card",t.IDEAL="idealBank",t.Sepa="iban"}(C||(C={})),function(t){t.Alipay="alipay",t.CreditCard="card",t.IDEAL="ideal",t.Sepa="sepa_debit"}(E||(E={})),function(t){t.AuthFailure="auth_failure"}(P||(P={}));class b extends c{constructor(t){super(t===P.AuthFailure?"User did not authenticate":"There was an error while processing your payment. Please try again or contact us."),this.type="stripev3_error",this.subtype=t}}var w=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};const A=[C.Alipay,C.IDEAL];class O{constructor(t,e){this.paymentIntegrationService=t,this.scriptLoader=e}initialize(t){return w(this,void 0,void 0,function*(){const{stripev3:e,methodId:i,gatewayId:n}=t;if(!n)throw new h('Unable to initialize payment because "gatewayId" argument is not provided.');this.initializeOptions=e,this.isDeinitialize=!1;const r=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(i),{initializationData:{stripePublishableKey:o,stripeConnectedAccount:s,useIndividualCardFields:a,allowRedisplayForStoredInstruments:d}}=r;this._allowRedisplayForStoredInstruments=d;const l=this.getInitializeOptions().form;this.useIndividualCardFields=a,this.stripeV3Client=yield this.loadStripeJs(o,s),this.isCreditCard(i)&&this.shouldShowTSVHostedForm(i,n)&&l?this.hostedForm=yield this.mountCardVerificationFields(l):this.stripeElement=yield this.mountCardFields(i)})}execute(t,i){var n,r;return w(this,void 0,void 0,function*(){const{payment:o}=t,a=function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(i[n[r]]=t[n[r]])}return i}(t,["payment"]);let d,l;if(!o||!o.paymentData)throw new u(["payment.paymentData"]);const{paymentData:c,gatewayId:h,methodId:g}=o,{shouldSaveInstrument:v,shouldSetAsDefaultInstrument:S}=p(c)?c:{shouldSaveInstrument:!1,shouldSetAsDefaultInstrument:!1},f=e(A,g),{isStoreCreditApplied:_}=this.paymentIntegrationService.getState().getCheckoutOrThrow();_&&(yield this.paymentIntegrationService.applyStoreCredit(_));try{f&&(yield this.paymentIntegrationService.submitOrder(a,i)),h&&(yield this.paymentIntegrationService.loadPaymentMethod(h,{params:{method:g}}));const t=this.paymentIntegrationService.getState();if(m(c)){yield this.paymentIntegrationService.submitOrder(a,i);const{instrumentId:e}=c,n=t.getPaymentMethodOrThrow(o.methodId).clientToken;if(!n)throw new y(s.MissingPaymentMethod);return yield this.executeWithVaulted(o,e,S,n)}const e=t.getPaymentMethodOrThrow(g),u=yield this.confirmStripePayment(e),{clientToken:p,method:_}=e,{id:I}=null!==(r=null!==(n=u.paymentIntent)&&void 0!==n?n:u.paymentMethod)&&void 0!==r?r:{id:""};l=u.error,d={credit_card_token:{token:I},vault_payment_instrument:v,confirm:!1,set_as_default_stored_instrument:S},_===C.CreditCard&&(d.client_token=p),f||(yield this.paymentIntegrationService.submitOrder(a,i));const E=this.buildPaymentPayload(g,d,S);yield this.paymentIntegrationService.submitPayment(E)}catch(t){yield this.processAdditionalAction(this.handleEmptyPaymentIntentError(t,l),g,v,S)}})}finalize(){return Promise.reject(new g)}deinitialize(){return this.hostedForm&&this.hostedForm.detach(),this.isDeinitialize=!0,this.unmountElement(),Promise.resolve()}buildPaymentPayload(t,e,i){return{methodId:t,paymentData:i?{formattedPayload:Object.assign(Object.assign({},e),{set_as_default_stored_instrument:i})}:{formattedPayload:e}}}isCancellationError(t){var e,i;return t&&-1!==(null===(i=null===(e=t.payment_intent.last_payment_error)||void 0===e?void 0:e.message)||void 0===i?void 0:i.indexOf("canceled"))}isAuthError(t){return"payment_intent_authentication_failure"===(null==t?void 0:t.code)}isCreditCard(t){return t===E.CreditCard}isHostedFieldAvailable(){var t;const e=this.getInitializeOptions(),r=n(null===(t=e.form)||void 0===t?void 0:t.fields,i);return!i(r)}isHostedPaymentFormEnabled(t,e){const{getPaymentMethodOrThrow:i}=this.paymentIntegrationService.getState(),n=i(t,e);return Boolean(n.config.isHostedFormEnabled)}confirmStripePayment(t){return w(this,void 0,void 0,function*(){const{clientToken:e,method:i,returnUrl:n}=t;if(!e)throw new y(s.MissingPaymentMethod);switch(i){case C.Alipay:return this.getStripeJs().confirmAlipayPayment(e,{return_url:n},{handleActions:!1});case C.IDEAL:{const t=this.mapStripePaymentData(E.IDEAL,n);return this.getStripeJs().confirmIdealPayment(e,t,{handleActions:!1})}case C.Sepa:{const t=this.mapStripePaymentData(E.Sepa);return this.getStripeJs().confirmSepaDebitPayment(e,t)}default:{const t=this.useIndividualCardFields?this.getStripeCardElements()[0]:this.getStripeElement(),e=this.mapStripeBillingDetails(this.paymentIntegrationService.getState().getBillingAddress(),this.paymentIntegrationService.getState().getCustomer()),i=this._allowRedisplayForStoredInstruments;return this.getStripeJs().createPaymentMethod(Object.assign({type:E.CreditCard,card:t,billing_details:e},i?{allow_redisplay:"always"}:{}))}}})}executeWithVaulted(t,e,i,n){var r;return w(this,void 0,void 0,function*(){const o={bigpay_token:{token:e},confirm:!0,client_token:n,set_as_default_stored_instrument:i};if(this.isHostedPaymentFormEnabled(t.methodId,t.gatewayId)&&this.hostedForm){const e=this.hostedForm;return t.paymentData&&m(t.paymentData)&&(t.paymentData=Object.assign(Object.assign({},t.paymentData),{instrumentId:JSON.stringify({token:(null===(r=t.paymentData)||void 0===r?void 0:r.instrumentId)||"",client_token:n})})),yield e.validate(),yield e.submit(t),this.paymentIntegrationService.loadCurrentOrder()}const s=this.buildPaymentPayload(t.methodId,o,i);return this.paymentIntegrationService.submitPayment(s)})}getInitializeOptions(){if(!this.initializeOptions)throw new v(a.PaymentNotInitialized);return this.initializeOptions}getStripeCardElements(){if(!this.stripeCardElements)throw new v(a.PaymentNotInitialized);return this.stripeCardElements}getStripeElement(){if(!this.stripeElement)throw new v(a.PaymentNotInitialized);return this.stripeElement}getStripeJs(){if(!this.stripeV3Client)throw new v(a.PaymentNotInitialized);return this.stripeV3Client}handleEmptyPaymentIntentError(t,e){return S(t)&&o(t.body.errors,{code:"required_field"})&&e?new Error(e.message):t}loadStripeJs(t,e){return w(this,void 0,void 0,function*(){return this.stripeV3Client?Promise.resolve(this.stripeV3Client):this.scriptLoader.load(t,e,this.paymentIntegrationService.getState().getLocale())})}mapStripeAddress(t){if(t){const{city:e,countryCode:i,address1:n,address2:r,postalCode:o,stateOrProvinceCode:s}=t;return{city:e,country:i,line1:n,line2:r,postal_code:o,state:s}}return{line1:""}}mapStripeBillingDetails(t,e){const{firstName:i,lastName:n}=t||e||{firstName:"Guest",lastName:""},r=`${i} ${n}`.trim(),{options:o}=this.getInitializeOptions();if(this.useIndividualCardFields&&_(o)){const{zipCodeElementOptions:e}=o;if(e){const i=document.getElementById(e.containerId)?document.getElementById(e.containerId).value:"";i&&t&&(t=Object.assign(Object.assign({},t),{postalCode:i}))}}const s={address:this.mapStripeAddress(t)};if(e&&e.addresses[0]&&function(t){return"object"==typeof t&&null!==t&&"id"in t&&void 0!==t.id}(e.addresses[0])){const t=e.addresses[0],{email:i}=e,{phone:n}=t;return n?Object.assign(Object.assign({},s),{email:i,name:r,phone:n}):Object.assign(Object.assign({},s),{email:i,name:r})}if(t){const{email:e,phone:i}=t;return i?Object.assign(Object.assign({},s),{email:e,name:r,phone:i}):Object.assign(Object.assign({},s),{email:e,name:r})}return Object.assign(Object.assign({},s),{name:r})}mapStripePaymentData(t,e){const i=this.paymentIntegrationService.getState().getCustomer(),n=this.paymentIntegrationService.getState().getBillingAddress(),r={payment_method:{[t]:this.getStripeElement(),billing_details:this.mapStripeBillingDetails(n,i)}};return t===E.IDEAL?Object.assign(Object.assign({},r),{return_url:e}):r}mountCardFields(t){const{options:e,containerId:i}=this.getInitializeOptions();let n;return new Promise((r,o)=>{switch(this.stripeElements||(this.stripeElements=this.getStripeJs().elements()),t){case C.CreditCard:if(this.useIndividualCardFields&&_(e)){const{cardNumberElementOptions:t,cardExpiryElementOptions:i,cardCvcElementOptions:r}=e,s=this.stripeElements.getElement(C.CardNumber)||this.stripeElements.create(C.CardNumber,t),a=this.stripeElements.getElement(C.CardExpiry)||this.stripeElements.create(C.CardExpiry,i),d=this.stripeElements.getElement(C.CardCvc)||this.stripeElements.create(C.CardCvc,r);this.stripeCardElements=[s,a,d],n=this.stripeCardElements[0];try{s.mount(`#${t.containerId}`),a.mount(`#${i.containerId}`),d.mount(`#${r.containerId}`)}catch(t){this.isDeinitialize||o(new h("Unable to mount Stripe component without valid container ID."))}}else{n=this.stripeElements.getElement(t)||this.stripeElements.create(t,e);try{n.mount(`#${i}`)}catch(t){this.isDeinitialize||o(new h("Unable to mount Stripe component without valid container ID."))}}break;case C.IDEAL:case C.Sepa:n=this.stripeElements.getElement(t)||this.stripeElements.create(t,e);try{n.mount(`#${i}`)}catch(t){this.isDeinitialize||o(new h("Unable to mount Stripe component without valid container ID."))}case C.Alipay:}r(n)})}mountCardVerificationFields(t){return w(this,void 0,void 0,function*(){const e=this.paymentIntegrationService.getState().getStoreConfig();if(!e)throw new y(s.MissingCheckoutConfig);const i=e.paymentSettings.bigpayBaseUrl,n=this.paymentIntegrationService.createHostedForm(i,t);return yield n.attach(),n})}processAdditionalAction(t,e,i=!1,n=!1){return w(this,void 0,void 0,function*(){if(!S(t))throw t;const r=o(t.body.errors,{code:"additional_action_required"}),s=o(t.body.errors,{code:"three_d_secure_required"});if(r){const e=t.body.additional_action_required;if(e&&"redirect_to_url"===e.type)return new Promise(()=>{e.data.redirect_url&&window.location.replace(e.data.redirect_url)})}if(s){const r=t.body.three_ds_result.token,o=!1;let s,a=!1;try{s=yield this.getStripeJs().confirmCardPayment(r)}catch(t){a=!0}if(null==s?void 0:s.error){if(this.isCancellationError(s.error))throw new f;if(this.isAuthError(s.error))throw new b(P.AuthFailure);throw new Error(s.error.message)}const d={credit_card_token:{token:this.getPaymentToken(null==s?void 0:s.paymentIntent,r,a)},vault_payment_instrument:i,confirm:o},l=this.buildPaymentPayload(e,d,n);try{return yield this.paymentIntegrationService.submitPayment(l)}catch(t){throw this.handleEmptyPaymentIntentError(t,null==s?void 0:s.error)}}throw t})}getPaymentToken(t,e,i){return!t||i?e:t.id}shouldShowTSVHostedForm(t,e){return this.isHostedFieldAvailable()&&this.isHostedPaymentFormEnabled(t,e)}unmountElement(){this.stripeElement&&(this.stripeElement.unmount(),this.stripeElement=void 0)}}class M extends c{constructor(t){super(t||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}class k{constructor(t,e=window){this.scriptLoader=t,this.stripeWindow=e}load(t,e,i){return this.scriptLoader.loadScript("https://js.stripe.com/v3/").then(()=>{if(!this.stripeWindow.Stripe)throw new M;return this.stripeWindow.Stripe(t,{stripeAccount:e,locale:i,betas:["payment_intent_beta_3","alipay_pm_beta_1"],apiVersion:"2020-03-02;alipay_beta=v1"})})}}const T=l(e=>new O(e,new k(t())),[{gateway:"stripev3"}]);var N,R,D,z,L,U,x,V,j,B,F,G;!function(t){t.SHIPPING="shipping",t.BILLING="billing"}(N||(N={})),function(t){t.SPLIT="split",t.FULL="full",t.ORGANIZATION="organization"}(R||(R={})),function(t){t.Open="open",t.Expired="expired",t.Complete="complete"}(D||(D={})),function(t){t.Paid="paid",t.UnPaid="unpaid",t.NoPaymentRequired="no_payment_required"}(z||(z={})),function(t){t.SUCCESS="success",t.ERROR="error"}(L||(L={})),function(t){t.CreditCard="card",t.Link="link",t.EPS="eps",t.GRABPAY="grabpay",t.BANCONTACT="bancontact",t.IDEAL="ideal",t.ALIPAY="alipay",t.KLARNA="klarna",t.OCS="optimized_checkout"}(U||(U={})),function(t){t.NEVER="never",t.AUTO="auto",t.ALWAYS="always",t.PAYMENT="payment",t.IF_REQUIRED="if_required"}(x||(x={})),function(t){t.V3="v3",t.ACACIA="acacia",t.BASIL="basil",t.CLOVER="clover"}(V||(V={})),function(t){t.PAYMENT="payment",t.AUTHENTICATION="linkAuthentication",t.SHIPPING="address",t.EXPRESS_CHECKOUT="expressCheckout"}(j||(j={})),function(t){t.REQUIRES_PAYMENT_METHOD="requires_payment_method",t.REQUIRES_CONFIRMATION="requires_confirmation",t.REQUIRES_ACTION="requires_action",t.PROCESSING="processing",t.SUCCEEDED="succeeded",t.CANCELED="canceled"}(B||(B={})),function(t){t.CLICK="click",t.CHANGE="change",t.READY="ready",t.SHIPPING_ADDRESS_CHANGE="shippingaddresschange",t.SHIPPING_RATE_CHANGE="shippingratechange",t.CONFIRM="confirm",t.CANCEL="cancel",t.LOADER_START="loaderstart"}(F||(F={})),function(t){t.ON_SESSION="on_session",t.OFF_SESSION="off_session"}(G||(G={}));var H=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class q{constructor(t,e=window){this.scriptLoader=t,this.stripeWindow=e}getStripeClient(t,e,i,n,r){return H(this,void 0,void 0,function*(){if(this.stripeWindow.bcStripeClient)return this.stripeWindow.bcStripeClient;const o=yield this.load(i),{stripePublishableKey:s,stripeConnectedAccount:a}=t,d=o(s,Object.assign(Object.assign(Object.assign(Object.assign({},a?{stripeAccount:a}:{}),e?{locale:e}:{}),n?{betas:n}:{}),r?{apiVersion:r}:{}));return Object.assign(this.stripeWindow,{bcStripeClient:d}),d})}getElements(t,e){return H(this,void 0,void 0,function*(){let i=this.stripeWindow.bcStripeElements;return i?yield this.updateStripeElements(e):(i=t.elements(e),Object.assign(this.stripeWindow,{bcStripeElements:i})),i})}updateStripeElements(t){return H(this,void 0,void 0,function*(){const e=this.stripeWindow.bcStripeElements;e&&(e.update(t),yield e.fetchUpdates())})}getStripeCheckout(t,e){return H(this,void 0,void 0,function*(){let i=this.stripeWindow.bcStripeCheckout;return i||(i=yield t.initCheckout(e),Object.assign(this.stripeWindow,{bcStripeCheckout:i})),i})}load(t){return H(this,void 0,void 0,function*(){if(!this.stripeWindow.Stripe&&(yield this.scriptLoader.loadScript(this.getScriptUrl(t)),!this.stripeWindow.Stripe))throw new M;return this.stripeWindow.Stripe})}getScriptUrl(t){return t&&t!==V.V3?`https://js.stripe.com/${t}/stripe.js`:"https://js.stripe.com/v3/"}}class W extends c{constructor(t){super(t||"Unable to proceed because the client library of a payment method has thrown an unexpected error."),this.name="PaymentMethodFailedError",this.type="payment_method_client_invalid"}}var Y=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class ${constructor(t,e){this.paymentIntegrationService=t,this.scriptLoader=e,this.isMounted=!1}deinitialize(){var t;null===(t=this.checkoutEventsUnsubscribe)||void 0===t||t.call(this),this.isMounted=!1}initCheckoutEventsSubscription(t,e,i,n){this.checkoutEventsUnsubscribe=this.paymentIntegrationService.subscribe(()=>Y(this,void 0,void 0,function*(){var r;const o=null==n?void 0:n.getElement(j.PAYMENT);if(o){try{yield this.updateStripePaymentIntent(t,e)}catch(t){return this.isMounted&&(o.unmount(),this.isMounted=!1),void(t instanceof Error&&(null===(r=i.onError)||void 0===r||r.call(i,t)))}this.isMounted||(yield null==n?void 0:n.fetchUpdates(),this.mountElement(o,i.containerId))}}),t=>{var e;return null===(e=t.getCheckout())||void 0===e?void 0:e.outstandingBalance},t=>{var e;return null===(e=t.getCheckout())||void 0===e?void 0:e.coupons})}mountElement(t,e){document.getElementById(e)&&(t.mount(`#${e}`),this.isMounted=!0)}mapAppearanceVariables(t){return{colorPrimary:t.fieldInnerShadow,colorBackground:t.fieldBackground,colorText:t.labelText,colorDanger:t.fieldErrorText,colorTextSecondary:t.labelText,colorTextPlaceholder:t.fieldPlaceholderText,colorIcon:t.fieldPlaceholderText}}mapInputAppearanceRules(t){return{borderColor:t.fieldBorder,color:t.fieldText,boxShadow:t.fieldInnerShadow}}throwStripeError(t){if("object"==typeof(e=t)&&null!==e&&"type"in e&&(this.throwDisplayableStripeError(t),this.isCancellationError(t)))throw new f;var e;throw new W}throwDisplayableStripeError(t){if(e(["card_error","invalid_request_error","validation_error"],t.type))throw new Error(t.message)}isCancellationError(t){var e;const i=null===(e=null==t?void 0:t.payment_intent.last_payment_error)||void 0===e?void 0:e.message;return!!i&&-1!==i.indexOf("canceled")}throwPaymentConfirmationProceedMessage(){throw new W("We've received your order and are processing your payment. Once the payment is verified, your order will be completed. We will send you an email when it's completed. Please note, this process may take a few minutes depending on the processing times of your chosen method.")}isPaymentCompleted(t,e){return Y(this,void 0,void 0,function*(){const i=this.paymentIntegrationService.getState(),n=i.getPaymentMethodOrThrow(t),{features:r}=i.getStoreConfigOrThrow().checkoutSettings;if(!n.clientToken||!e||!r["PI-626.Block_unnecessary_payment_confirmation_for_StripeUPE"])return!1;const{paymentIntent:o}=yield e.retrievePaymentIntent(n.clientToken);return(null==o?void 0:o.status)===B.SUCCEEDED})}mapStripePaymentData(t,e,i=!1){const n=this.paymentIntegrationService.getState().getBillingAddress(),{firstName:r="",lastName:o="",email:d=""}=n||{},l=this._mapStripeAddress(n);if(!t)throw new v(a.PaymentNotInitialized);if(!(d&&l&&l.city&&l.country&&r&&o))throw new y(s.MissingBillingAddress);return{elements:t,redirect:x.IF_REQUIRED,confirmParams:Object.assign({payment_method_data:Object.assign(Object.assign({},i?{allow_redisplay:"always"}:{}),{billing_details:{email:d,address:l,name:`${r} ${o}`}})},e&&{return_url:e})}}isAdditionalActionError(t){return o(t,{code:"additional_action_required"})}isRedirectAction(t){const{type:e,data:{redirect_url:i}}=t;return"redirect_to_url"===e&&!!i}isOnPageAdditionalAction(t){const{type:e,data:{token:i}}=t;return"additional_action_requires_payment_method"===e&&!!i}updateStripePaymentIntent(t,e){return Y(this,void 0,void 0,function*(){const i=yield this.paymentIntegrationService.loadPaymentMethod(t,{params:{method:e}}),{clientToken:n}=i.getPaymentMethodOrThrow(e);n&&this.scriptLoader.updateStripeElements({clientSecret:n})})}getStripeJsVersion(t){return t.useNewStripeJsVersion?V.CLOVER:V.V3}_mapStripeAddress(t){if(t){const{city:e,address1:i,address2:n,countryCode:r,postalCode:o,stateOrProvinceCode:s}=t;return Object.assign({city:e,country:r,postal_code:o,line1:i,line2:n},s?{state:s}:{})}throw new y(s.MissingBillingAddress)}}const J={body:{},headers:{},status:0};class K extends c{constructor(t,{message:e,errors:i}={}){const{body:n,headers:r,status:o}=t||J;super(e||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=n,this.headers=r,this.status=o,this.errors=i||[]}}function Z(t){return"object"==typeof t&&null!==t&&"initializationData"in t&&void 0!==t.initializationData&&null!==t.initializationData&&"object"==typeof t.initializationData&&"stripePublishableKey"in t.initializationData&&"stripeConnectedAccount"in t.initializationData&&"shopperLanguage"in t.initializationData&&void 0!==t.initializationData.stripePublishableKey&&void 0!==t.initializationData.stripeConnectedAccount&&void 0!==t.initializationData.shopperLanguage}const Q={ar:["ar"],bg:["bg"],cs:["cs"],da:["da"],de:["de"],el:["el"],en:["en","en-GB"],es:["es","es-419"],et:["et"],fi:["fi"],fil:["fil"],fr:["fr","fr-CA"],he:["he"],hr:["hr"],hu:["hu"],id:["id"],it:["it"],ja:["ja"],ko:["ko"],lt:["lt"],lv:["lv"],ms:["ms"],mt:["mt"],nb:["nb"],nl:["nl"],pl:["pl"],pt:["pt","pt-BR"],ro:["ro"],ru:["ru"],sk:["sk"],sl:["sl"],sv:["sv"],th:["th"],tr:["tr"],vi:["vi"],zh:["zh","zh-HK","zh-TW"]};function X(t){const[e,i]=t.replace(/_/g,"-").toLowerCase().split("-"),n=Q[e];if(!n)return"auto";const r=i?`${e}-${i.toUpperCase()}`:e;return n.indexOf(r)>-1?r:n[0]}const tt=["payment_element_beta_2","alipay_pm_beta_1","link_default_integration_beta_1","shipping_address_element_beta_1","address_element_beta_1"],et="2020-03-02;alipay_beta=v1;link_beta=v1";function it(t){return"stripeLinkAuthenticationState"in t}var nt=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class rt{constructor(t,e,i){this.paymentIntegrationService=t,this.scriptLoader=e,this.stripeIntegrationService=i}initialize(t){return nt(this,void 0,void 0,function*(){const{stripeupe:e,methodId:i,gatewayId:n}=t;if(!(null==e?void 0:e.containerId))throw new v(a.PaymentNotInitialized);if(!n)throw new h('Unable to initialize payment because "gatewayId" argument is not provided.');return this._loadStripeElement(e,n,i).catch(t=>{var i;return null===(i=e.onError)||void 0===i?void 0:i.call(e,t)}),this.stripeIntegrationService.initCheckoutEventsSubscription(n,i,e,this._stripeElements),Promise.resolve()})}execute(t,e){return nt(this,void 0,void 0,function*(){const{payment:i}=t,n=function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(i[n[r]]=t[n[r]])}return i}(t,["payment"]);if(!i||!i.paymentData)throw new u(["payment.paymentData"]);if(!this._stripeUPEClient)throw new v(a.PaymentNotInitialized);const{paymentData:r,methodId:o,gatewayId:s}=i,{shouldSaveInstrument:d=!1,shouldSetAsDefaultInstrument:l=!1}=p(r)?r:{},c=this.paymentIntegrationService.getState(),{isStoreCreditApplied:h}=c.getCheckoutOrThrow(),y=c.getPaymentProviderCustomerOrThrow(),g=(it(y)?y:{}).stripeLinkAuthenticationState;if(h&&(yield this.paymentIntegrationService.applyStoreCredit(h)),s){yield this.stripeIntegrationService.updateStripePaymentIntent(s,o);const{email:t}=c.getCustomerOrThrow();if(void 0!==g&&!t){const t=c.getBillingAddressOrThrow();yield this.paymentIntegrationService.updateBillingAddress(t)}}if(yield this.paymentIntegrationService.submitOrder(n,e),m(r)){const{instrumentId:t}=r;return void(yield this._executeWithVaulted(i.methodId,t,l))}yield this._executeWithStripeConfirmation(i.methodId,!g&&d,l)})}finalize(){return Promise.reject(new g)}deinitialize(){var t,e;return null===(e=null===(t=this._stripeElements)||void 0===t?void 0:t.getElement(j.PAYMENT))||void 0===e||e.unmount(),this.stripeIntegrationService.deinitialize(),this._stripeElements=void 0,this._stripeUPEClient=void 0,Promise.resolve()}_executeWithStripeConfirmation(t,e,i){return nt(this,void 0,void 0,function*(){const n=this.paymentIntegrationService.getState(),{clientToken:r}=n.getPaymentMethodOrThrow(t),o=this._getPaymentPayload(t,r||"",e,i);try{yield this.paymentIntegrationService.submitPayment(o)}catch(n){yield this._processAdditionalActionWithStripeConfirmation(n,t,e,i)}})}_executeWithVaulted(t,e,i){var n;return nt(this,void 0,void 0,function*(){const r=this.paymentIntegrationService.getState(),o=r.getPaymentMethodOrThrow(t),s=null===(n=r.getCart())||void 0===n?void 0:n.id;try{const n={methodId:t,paymentData:{formattedPayload:{cart_id:s,bigpay_token:{token:e},confirm:!1,client_token:o.clientToken,set_as_default_stored_instrument:i}}};return yield this.paymentIntegrationService.submitPayment(n)}catch(e){return this._processVaultedAdditionalAction(e,t,i)}})}_loadStripeElement(t,e,i){return nt(this,void 0,void 0,function*(){const{containerId:n,style:r,render:o,initStripeElementUpdateTrigger:a}=t,d=yield this.paymentIntegrationService.loadPaymentMethod(e,{params:{method:i}}),l=d.getPaymentMethodOrThrow(i);if(!Z(l))throw new y(s.MissingPaymentMethod);const{clientToken:c,initializationData:h}=l,{shopperLanguage:u,allowRedisplayForStoredInstruments:p=!1,enableLink:m}=h;if(this._allowRedisplayForStoredInstruments=p,!c)throw new y(s.MissingPaymentMethod);let g;if(this._stripeUPEClient=yield this._loadStripeJs(h),this._isStripeElementUpdateEnabled="function"==typeof a,r){const t=r;g={variables:this.stripeIntegrationService.mapAppearanceVariables(r),rules:{".Input":this.stripeIntegrationService.mapInputAppearanceRules(t)}}}this._stripeElements=yield this.scriptLoader.getElements(this._stripeUPEClient,{clientSecret:c,locale:X(u),appearance:g});const{getBillingAddress:v,getShippingAddress:S}=d,{postalCode:f}=S()||v()||{},_=this._stripeElements.getElement(j.PAYMENT)||this._stripeElements.create(j.PAYMENT,Object.assign({fields:{billingDetails:{email:x.NEVER,address:{country:x.NEVER,city:x.NEVER,postalCode:f?x.NEVER:x.AUTO}}},wallets:{applePay:x.NEVER,googlePay:x.NEVER,link:m?x.AUTO:x.NEVER}},this._getStripeElementTerms()));this.stripeIntegrationService.mountElement(_,n),_.on(F.READY,()=>{o()}),_.on(F.CHANGE,t=>{(null==t?void 0:t.value)&&"type"in t.value&&this._updateStripeLinkStateByElementType(t.value.type)}),this._isStripeElementUpdateEnabled&&(null==a||a(this._updateStripeElement.bind(this)))})}_processAdditionalActionWithStripeConfirmation(t,e,i=!1,n=!1){return nt(this,void 0,void 0,function*(){if(!S(t)||!this.stripeIntegrationService.isAdditionalActionError(t.body.errors))throw t;if(!this._stripeUPEClient||!this._stripeElements)throw new v(a.PaymentNotInitialized);const{data:r}=t.body.additional_action_required,{token:o}=r,{paymentIntent:s}=yield this._confirmStripePaymentOrThrow(e,r),d=this._getPaymentPayload(e,(null==s?void 0:s.id)||o,i,n);try{yield this.paymentIntegrationService.submitPayment(d)}catch(t){this.stripeIntegrationService.throwPaymentConfirmationProceedMessage()}})}_confirmStripePaymentOrThrow(t,e){var i,n;return nt(this,void 0,void 0,function*(){const{token:r,redirect_url:o}=e,s=this.stripeIntegrationService.mapStripePaymentData(this._stripeElements,o,!!this._allowRedisplayForStoredInstruments);let a;try{const e=(yield this.stripeIntegrationService.isPaymentCompleted(t,this._stripeUPEClient))?yield null===(n=this._stripeUPEClient)||void 0===n?void 0:n.retrievePaymentIntent(r||""):yield null===(i=this._stripeUPEClient)||void 0===i?void 0:i.confirmPayment(s);if(a=null==e?void 0:e.error,a||!(null==e?void 0:e.paymentIntent))throw new W;return e}catch(t){this.stripeIntegrationService.throwStripeError(a)}})}_processVaultedAdditionalAction(t,e,i=!1){var n;return nt(this,void 0,void 0,function*(){if(!e||!S(t)||!o(t.body.errors,{code:"three_d_secure_required"}))throw t;if(!this._stripeUPEClient||!this._stripeElements)throw new v(a.PaymentNotInitialized);const r=t.body.three_ds_result.token;let s,d=!1;try{s=yield this._stripeUPEClient.confirmCardPayment(r)}catch(t){try{s=yield this._stripeUPEClient.retrievePaymentIntent(r)}catch(t){d=!0}}if((null==s?void 0:s.error)&&this.stripeIntegrationService.throwStripeError(s.error),!(null==s?void 0:s.paymentIntent)&&!d)throw new K;const l=this._getPaymentPayload(e,d?r:null===(n=null==s?void 0:s.paymentIntent)||void 0===n?void 0:n.id,!1,i);return this.paymentIntegrationService.submitPayment(l)})}_loadStripeJs(t){return nt(this,void 0,void 0,function*(){if(this._stripeUPEClient)return this._stripeUPEClient;const e=this.paymentIntegrationService.getState();return this.scriptLoader.getStripeClient(t,e.getCartLocale(),V.V3,tt,et)})}_getPaymentPayload(t,e,i=!1,n=!1){var r;return{methodId:t,paymentData:{formattedPayload:{cart_id:(null===(r=this.paymentIntegrationService.getState().getCart())||void 0===r?void 0:r.id)||"",credit_card_token:{token:e},confirm:!1,vault_payment_instrument:i,set_as_default_stored_instrument:n}}}}_updateStripeElement({shouldShowTerms:t}){var e;const i=null===(e=this._stripeElements)||void 0===e?void 0:e.getElement(j.PAYMENT);null==i||i.update(Object.assign({},this._getStripeElementTerms(t)))}_getStripeElementTerms(t){let e=x.AUTO;return this._isStripeElementUpdateEnabled&&(e=t?x.AUTO:x.NEVER),{terms:{card:e}}}_updateStripeLinkStateByElementType(t){const e=this.paymentIntegrationService.getState().getPaymentProviderCustomerOrThrow(),i=t===U.Link;!it(e)&&i&&this.paymentIntegrationService.updatePaymentProviderCustomer({stripeLinkAuthenticationState:i})}}const ot=l(e=>{const i=new q(t());return new rt(e,i,new $(e,i))},[{gateway:"stripeupe"},{gateway:"stripeupe",id:"klarna"}]),st=t=>"object"==typeof t&&null!==t&&"value"in t&&"collapsed"in t;var at=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class dt{constructor(t,e,i){this.paymentIntegrationService=t,this.scriptLoader=e,this.stripeIntegrationService=i}initialize(t){var e;return at(this,void 0,void 0,function*(){const{stripeocs:i,methodId:n,gatewayId:r}=t;if(!(null==i?void 0:i.containerId))throw new v(a.PaymentNotInitialized);if(!r)throw new h('Unable to initialize payment because "gatewayId" argument is not provided.');try{yield this._initializeStripeElement(i,r,n)}catch(t){t instanceof Error&&(null===(e=i.onError)||void 0===e||e.call(i,t))}this.stripeIntegrationService.initCheckoutEventsSubscription(r,n,i,this.stripeElements)})}execute(t,e){return at(this,void 0,void 0,function*(){const{payment:i}=t,n=function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(i[n[r]]=t[n[r]])}return i}(t,["payment"]),{methodId:r,gatewayId:o}=i||{};if(!this.stripeClient)throw new v(a.PaymentNotInitialized);if(!o||!r)throw new h('Unable to initialize payment because "gatewayId" or "methodId" argument is not provided.');const{isStoreCreditApplied:s}=this.paymentIntegrationService.getState().getCheckoutOrThrow();s&&(yield this.paymentIntegrationService.applyStoreCredit(s)),yield this.stripeIntegrationService.updateStripePaymentIntent(o,r),yield this.paymentIntegrationService.submitOrder(n,e);const{clientToken:d}=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(r,o),l=this._getPaymentPayload(r,d||"");try{yield this.paymentIntegrationService.submitPayment(l)}catch(t){yield this._processAdditionalAction(t,r)}})}finalize(){return Promise.reject(new g)}deinitialize(){var t;const e=null===(t=this.stripeElements)||void 0===t?void 0:t.getElement(j.PAYMENT);return null==e||e.unmount(),null==e||e.destroy(),this.stripeIntegrationService.deinitialize(),this.stripeElements=void 0,this.stripeClient=void 0,Promise.resolve()}_initializeStripeElement(t,e,i){return at(this,void 0,void 0,function*(){let n=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(i,e);if((null==n?void 0:n.clientToken)||(n=(yield this.paymentIntegrationService.loadPaymentMethod(e,{params:{method:i}})).getPaymentMethodOrThrow(i,e)),!Z(n))throw new y(s.MissingPaymentMethod);const{clientToken:r,initializationData:o}=n,{shopperLanguage:a,customerSessionToken:d,enableLink:l}=o;if(!r)throw new y(s.MissingPaymentMethod);this.stripeClient=yield this._loadStripeJs(o);const{appearance:c,containerId:h,fonts:u,layout:p,render:m,paymentMethodSelect:g,handleClosePaymentMethod:v,togglePreloader:S}=t;this.stripeElements=yield this.scriptLoader.getElements(this.stripeClient,{clientSecret:r,customerSessionClientSecret:d,locale:X(a),appearance:c,fonts:u});const{getBillingAddress:f,getShippingAddress:_}=this.paymentIntegrationService.getState(),I=f(),{postalCode:C}=_()||I||{},E=this.stripeElements.getElement(j.PAYMENT)||this.stripeElements.create(j.PAYMENT,{fields:{billingDetails:{email:x.NEVER,address:{country:x.NEVER,city:x.NEVER,postalCode:C?x.NEVER:x.AUTO}}},wallets:{applePay:x.NEVER,googlePay:x.NEVER,link:l?x.AUTO:x.NEVER},layout:p,savePaymentMethod:{maxVisiblePaymentMethods:20},defaultValues:{billingDetails:{email:(null==I?void 0:I.email)||""}}});this.stripeIntegrationService.mountElement(E,h),E.on(F.LOADER_START,()=>{null==S||S(!1)}),E.on(F.READY,()=>{m()}),E.on(F.CHANGE,t=>{this._onStripeElementChange(t,e,i,g)}),null==v||v(this._collapseStripeElement.bind(this))})}_loadStripeJs(t){return at(this,void 0,void 0,function*(){if(this.stripeClient)return this.stripeClient;const e=this.paymentIntegrationService.getState(),i=this.stripeIntegrationService.getStripeJsVersion(t);return this.scriptLoader.getStripeClient(t,e.getCartLocale(),i)})}_collapseStripeElement(){var t;const e=null===(t=this.stripeElements)||void 0===t?void 0:t.getElement(j.PAYMENT);null==e||e.collapse()}_getPaymentPayload(t,e,i){var n;const r=(null===(n=this.paymentIntegrationService.getState().getCart())||void 0===n?void 0:n.id)||"",{card:o,us_bank_account:s}=i||{},a=this._shouldSaveInstrument(o)||this._shouldSaveInstrument(s),d=this._getTokenizedOptions(e,i);return{methodId:t,paymentData:{formattedPayload:Object.assign({cart_id:r,confirm:!1,method:this.selectedMethodId,vault_payment_instrument:a},d)}}}_processAdditionalAction(t,e){return at(this,void 0,void 0,function*(){if(!S(t)||!this.stripeIntegrationService.isAdditionalActionError(t.body.errors))throw t;if(!this.stripeClient||!this.stripeElements)throw new v(a.PaymentNotInitialized);const{data:i}=t.body.additional_action_required,{token:n}=i,{paymentIntent:r}=yield this._confirmStripePaymentOrThrow(e,i),{client_secret:o,payment_method_options:s}=r||{},d=this._getPaymentPayload(e,o||n,s);try{return yield this.paymentIntegrationService.submitPayment(d)}catch(t){this.stripeIntegrationService.throwPaymentConfirmationProceedMessage()}})}_confirmStripePaymentOrThrow(t,e){var i,n;return at(this,void 0,void 0,function*(){const{token:r,redirect_url:o}=e,s=this.stripeIntegrationService.mapStripePaymentData(this.stripeElements,o);let a;try{const e=(yield this.stripeIntegrationService.isPaymentCompleted(t,this.stripeClient))?yield null===(n=this.stripeClient)||void 0===n?void 0:n.retrievePaymentIntent(r||""):yield null===(i=this.stripeClient)||void 0===i?void 0:i.confirmPayment(s);if(a=null==e?void 0:e.error,a||!(null==e?void 0:e.paymentIntent))throw new W;return e}catch(t){return this.stripeIntegrationService.throwStripeError(a)}})}_onStripeElementChange(t,e,i,n){st(t)&&!t.collapsed&&(this.selectedMethodId=t.value.type,null==n||n(`${e}-${i}`))}_shouldSaveInstrument(t){const e=null==t?void 0:t.setup_future_usage;return e===G.ON_SESSION||e===G.OFF_SESSION}_getTokenizedOptions(t,e){return this._shouldSaveInstrument(null==e?void 0:e.us_bank_account)?{tokenized_ach:{token:t}}:{credit_card_token:{token:t}}}}const lt=l(e=>{const i=new q(t());return new dt(e,i,new $(e,i))},[{gateway:"stripeocs",id:"optimized_checkout"}]);var ct=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class ht{constructor(t,e,i){this.paymentIntegrationService=t,this.scriptLoader=e,this.stripeIntegrationService=i}initialize(t){var e;return ct(this,void 0,void 0,function*(){const{stripeocs:i,methodId:n,gatewayId:r}=t;if(!(null==i?void 0:i.containerId)||!r)throw new v(a.PaymentNotInitialized);try{yield this._initializeStripeElement(i,r,n)}catch(t){t instanceof Error&&(null===(e=i.onError)||void 0===e||e.call(i,t))}})}execute(t,e){return ct(this,void 0,void 0,function*(){const{payment:i}=t,n=function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(i[n[r]]=t[n[r]])}return i}(t,["payment"]),{methodId:r,gatewayId:o}=i||{};if(!this.stripeClient)throw new v(a.PaymentNotInitialized);if(!o||!r)throw new h('Unable to initialize payment because "gatewayId" or "methodId" argument is not provided.');const s=this.paymentIntegrationService.getState(),{isStoreCreditApplied:d}=s.getCheckoutOrThrow();d&&(yield this.paymentIntegrationService.applyStoreCredit(d)),yield this._updateCheckoutSessionData(o,r),yield this.paymentIntegrationService.submitOrder(n,e);const{clientToken:l}=s.getPaymentMethodOrThrow(r),c=this._getPaymentPayload(r,l||"");try{yield this.paymentIntegrationService.submitPayment(c)}catch(t){yield this._processAdditionalAction(t,r)}})}finalize(){return Promise.reject(new g)}deinitialize(){var t;const e=null===(t=this.stripeCheckout)||void 0===t?void 0:t.getPaymentElement();return null==e||e.unmount(),null==e||e.destroy(),this.stripeCheckout=void 0,this.stripeClient=void 0,this.selectedMethodId=void 0,Promise.resolve()}_initializeStripeElement(t,e,i){return ct(this,void 0,void 0,function*(){let n=this.paymentIntegrationService.getState().getPaymentMethodOrThrow(i,e);if((null==n?void 0:n.clientToken)||(n=(yield this.paymentIntegrationService.loadPaymentMethod(e,{params:{method:i}})).getPaymentMethodOrThrow(i,e)),!Z(n))throw new y(s.MissingPaymentMethod);const{clientToken:r,initializationData:o}=n;if(!r)throw new y(s.MissingPaymentMethod);this.stripeClient=yield this._loadStripeJs(o);const{enableLink:d}=o,{appearance:l,containerId:c,fonts:h,layout:u,render:p,paymentMethodSelect:m,handleClosePaymentMethod:g,togglePreloader:S}=t,{getBillingAddress:f,getShippingAddress:_}=this.paymentIntegrationService.getState(),I=f(),{postalCode:C}=_()||I||{};this.stripeCheckout=yield this.scriptLoader.getStripeCheckout(this.stripeClient,{clientSecret:r,elementsOptions:{appearance:l,fonts:h},adaptivePricing:{allowed:!1}});const E=yield this._getStripeActionsOrThrow();yield E.updateEmail((null==I?void 0:I.email)||"");const P=this._getStripeElement({fields:{billingDetails:{email:x.NEVER,address:{country:x.NEVER,city:x.NEVER,postalCode:C?x.NEVER:x.AUTO}}},wallets:{applePay:x.NEVER,googlePay:x.NEVER,link:d?x.AUTO:x.NEVER},layout:u});if(!P)throw new v(a.PaymentNotInitialized);this.stripeIntegrationService.mountElement(P,c),P.on(F.LOADER_START,()=>{null==S||S(!1)}),P.on(F.READY,()=>{p()}),P.on(F.CHANGE,t=>{this._onStripeElementChange(t,e,i,m)}),null==g||g(this._collapseStripeElement.bind(this))})}_loadStripeJs(t){return ct(this,void 0,void 0,function*(){if(this.stripeClient)return this.stripeClient;const e=this.paymentIntegrationService.getState();return this.scriptLoader.getStripeClient(t,e.getCartLocale(),V.CLOVER)})}_getStripeActionsOrThrow(){return ct(this,void 0,void 0,function*(){if(!this.stripeCheckout)throw new v(a.PaymentNotInitialized);const{actions:t,error:e}=yield this.stripeCheckout.loadActions();if(!t||e)throw new W(null==e?void 0:e.message);return t})}_getStripeElement(t){var e,i;return(null===(e=this.stripeCheckout)||void 0===e?void 0:e.getPaymentElement())||(null===(i=this.stripeCheckout)||void 0===i?void 0:i.createPaymentElement(t))}_onStripeElementChange(t,e,i,n){st(t)&&!t.collapsed&&(this.selectedMethodId=t.value.type,null==n||n(`${e}-${i}`))}_collapseStripeElement(){var t;const e=null===(t=this.stripeCheckout)||void 0===t?void 0:t.getPaymentElement();null==e||e.collapse()}_updateCheckoutSessionData(t,e){return ct(this,void 0,void 0,function*(){yield this.paymentIntegrationService.loadPaymentMethod(t,{params:{method:e}})})}_getPaymentPayload(t,e){var i;return{methodId:t,paymentData:{formattedPayload:{cart_id:(null===(i=this.paymentIntegrationService.getState().getCart())||void 0===i?void 0:i.id)||"",confirm:!1,method:this.selectedMethodId,credit_card_token:{token:e}}}}}_processAdditionalAction(t,e){var i;return ct(this,void 0,void 0,function*(){if(!S(t)||!this.stripeIntegrationService.isAdditionalActionError(t.body.errors))throw t;const{data:n}=(null===(i=t.body)||void 0===i?void 0:i.additional_action_required)||{},{token:r}=n||{},{id:o,status:s}=yield this._confirmStripePaymentOrThrow(n),a=this._getPaymentPayload(e,o||r);try{return yield this.paymentIntegrationService.submitPayment(a)}catch(t){throw s.paymentStatus===z.Paid&&this.stripeIntegrationService.throwPaymentConfirmationProceedMessage(),t}})}_confirmStripePaymentOrThrow(t){return ct(this,void 0,void 0,function*(){const{redirect_url:e}=t||{};if(!this.stripeCheckout)throw new v(a.PaymentNotInitialized);const i=yield this._getStripeActionsOrThrow(),{session:n,error:r}=yield i.confirm({redirect:x.IF_REQUIRED,returnUrl:e});if(r||!n)throw new W(null==r?void 0:r.message);return n})}}const ut=l(e=>{const i=new q(t());return new ht(e,i,new $(e,i))},[{gateway:"stripeocs",id:"checkout_session"}]);class pt{constructor(t,e){this.paymentIntegrationService=t,this.scriptLoader=e}initialize(t){var e,i,n,r,o;return i=this,n=void 0,o=function*(){let i;if(!t.stripeupe)throw new h('Unable to proceed because "options" argument is not provided.');const{container:n,gatewayId:r,methodId:o,onEmailChange:a,getStyles:d,isLoading:l}=t.stripeupe;Object.entries(t.stripeupe).forEach(([t,e])=>{if(!e)throw new h(`Unable to proceed because "${t}" argument is not provided.`)}),yield this.paymentIntegrationService.loadPaymentMethod(r,{params:{method:o}});const c=this.paymentIntegrationService.getState(),u=c.getPaymentMethodOrThrow(o,r),{clientToken:p}=u;if(!Z(u)||!p)throw new y(s.MissingPaymentToken);const{email:m}=c.getCustomerOrThrow(),g=c.getPaymentProviderCustomerOrThrow(),v=(it(g)?g:{}).stripeLinkAuthenticationState;if(!m){let t;const r="function"==typeof d&&d();t=r?{variables:{colorPrimary:r.fieldInnerShadow,colorBackground:r.fieldBackground,colorText:r.labelText,colorDanger:r.fieldErrorText,colorTextSecondary:r.labelText,colorTextPlaceholder:r.fieldPlaceholderText},rules:{".Input":{borderColor:r.fieldBorder,color:r.fieldText,boxShadow:r.fieldInnerShadow}}}:{},i=yield this.scriptLoader.getStripeClient(u.initializationData,c.getCartLocale(),V.V3,tt,et),this._stripeElements=yield this.scriptLoader.getElements(i,{clientSecret:p,appearance:t});const{getBillingAddress:o,getConsignments:h}=this.paymentIntegrationService.getState(),m=h(),g=null===(e=null==m?void 0:m[0])||void 0===e?void 0:e.id,{email:S}=o()||{},f=S?{defaultValues:{mode:N.SHIPPING,email:S}}:{},_=this._stripeElements.getElement(j.AUTHENTICATION)||this._stripeElements.create(j.AUTHENTICATION,f);_.on(F.CHANGE,t=>{if(!("authenticated"in t))throw new y(s.MissingCustomer);this.paymentIntegrationService.updatePaymentProviderCustomer({stripeLinkAuthenticationState:t.authenticated}),t.complete?a(t.authenticated,t.value.email):a(!1,""),l&&l(!1),void 0===v&&t.authenticated&&g&&this.paymentIntegrationService.deleteConsignment(g)}),_.mount(`#${n}`)}},new((r=void 0)||(r=Promise))(function(t,e){function s(t){try{d(o.next(t))}catch(t){e(t)}}function a(t){try{d(o.throw(t))}catch(t){e(t)}}function d(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r(function(t){t(i)})).then(s,a)}d((o=o.apply(i,n||[])).next())})}deinitialize(){var t,e;return null===(e=null===(t=this._stripeElements)||void 0===t?void 0:t.getElement(j.AUTHENTICATION))||void 0===e||e.unmount(),Promise.resolve()}signIn(t,e){return this.paymentIntegrationService.signInCustomer(t,e),Promise.resolve()}signOut(t){return this.paymentIntegrationService.signOutCustomer(t),Promise.resolve()}executePaymentMethodCheckout(t){var e;return null===(e=null==t?void 0:t.continueWithCheckoutCallback)||void 0===e||e.call(t),Promise.resolve()}}const mt=l(e=>new pt(e,new q(t())),[{id:"stripeupe"}]),yt={size:70,color:"#d9d9d9",backgroundColor:"#ffffff"},gt={position:"fixed","background-color":"rgba(0, 0, 0, 0.4)","z-index":"1000"},vt="embedded-checkout-loading-indicator-rotation";class St{constructor(t){this.styles=Object.assign(Object.assign({},yt),t&&t.styles),this.containerStyles=Object.assign({},t&&t.containerStyles),this.defineAnimation(),this.container=this.buildContainer(),this.indicator=this.buildIndicator(),this.container.appendChild(this.indicator)}show(t){if(t){const e=document.getElementById(t);if(!e)throw new Error("Unable to attach the loading indicator because the parent ID is not valid.");e.appendChild(this.container)}this.container.style.visibility="visible",this.container.style.opacity="1"}hide(){const t=()=>{this.container.style.visibility="hidden",this.container.removeEventListener("transitionend",t)};this.container.addEventListener("transitionend",t),this.container.style.opacity="0"}buildContainer(){const t=document.createElement("div");return t.style.display="block",t.style.bottom="0",t.style.left="0",t.style.height="100%",t.style.width="100%",t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.transition="all 250ms ease-out",t.style.opacity="0",this.setStyleAttribute(t,this.containerStyles),t}buildIndicator(){const t=document.createElement("div");return t.style.display="block",t.style.width=`${this.styles.size}px`,t.style.height=`${this.styles.size}px`,t.style.borderRadius=`${this.styles.size}px`,t.style.border="solid 1px",t.style.borderColor=`${this.styles.backgroundColor} ${this.styles.backgroundColor} ${this.styles.color} ${this.styles.color}`,t.style.margin="0 auto",t.style.position="absolute",t.style.left="0",t.style.right="0",t.style.top="50%",t.style.transform="translateY(-50%) rotate(0deg)",t.style.transformStyle="preserve-3d",t.style.animation=`${vt} 500ms infinite cubic-bezier(0.69, 0.31, 0.56, 0.83)`,t}setStyleAttribute(t,e){Object.keys(e).forEach(i=>{t.style.setProperty(i,e[i])})}defineAnimation(){var t;if(document.getElementById(vt))return;const e=document.createElement("style");e.id=vt,null===(t=document.head)||void 0===t||t.appendChild(e),e.sheet instanceof CSSStyleSheet&&e.sheet.insertRule(`\n                @keyframes ${vt} {\n                    0% { transform: translateY(-50%) rotate(0deg); }\n                    100% { transform: translateY(-50%) rotate(360deg); }\n                }\n            `,0)}}class ft{constructor(t){this._decimalPlaces=t}toInteger(t){return Math.round(t*Math.pow(10,this._decimalPlaces))}}const _t=["AC","AD","AE","AF","AG","AI","AL","AM","AO","AQ","AR","AT","AU","AW","AX","AZ","BA","BB","BD","BE","BF","BG","BH","BI","BJ","BL","BM","BN","BO","BQ","BR","BS","BT","BV","BW","BY","BZ","CA","CD","CF","CG","CH","CI","CK","CL","CM","CN","CO","CR","CV","CW","CY","CZ","DE","DJ","DK","DM","DO","DZ","EC","EE","EG","EH","ER","ES","ET","FI","FJ","FK","FO","FR","GA","GB","GD","GE","GF","GG","GH","GI","GL","GM","GN","GP","GQ","GR","GS","GT","GU","GW","GY","HK","HN","HR","HT","HU","ID","IE","IL","IM","IN","IO","IQ","IS","IT","JE","JM","JO","JP","KE","KG","KH","KI","KM","KN","KR","KW","KY","KZ","LA","LB","LC","LI","LK","LR","LS","LT","LU","LV","LY","MA","MC","MD","ME","MF","MG","MK","ML","MM","MN","MO","MQ","MR","MS","MT","MU","MV","MW","MX","MY","MZ","NA","NC","NE","NG","NI","NL","NO","NP","NR","NU","NZ","OM","PA","PE","PF","PG","PH","PK","PL","PM","PN","PR","PS","PT","PY","QA","RE","RO","RS","RU","RW","SA","SB","SC","SD","SE","SG","SH","SI","SJ","SK","SL","SM","SN","SO","SR","SS","ST","SV","SX","SZ","TA","TC","TD","TF","TG","TH","TJ","TK","TL","TM","TN","TO","TR","TT","TV","TW","TZ","UA","UG","US","UY","UZ","VA","VC","VE","VG","VN","VU","WF","WS","XK","YE","YT","ZA","ZM","ZW","ZZ"];var It=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class Ct{constructor(t,e,i,n){this.paymentIntegrationService=t,this.scriptLoader=e,this.stripeIntegrationService=i,this.loadingIndicator=n}initialize(t){return It(this,void 0,void 0,function*(){const{stripeocs:e}=t||{};if(!e)throw new h('Unable to proceed because "options" argument is not provided.');const{methodId:i,gatewayId:n,container:r}=e;if(!r||!i||!n)throw new v(a.PaymentNotInitialized);const o=yield this.paymentIntegrationService.loadPaymentMethod(n,{params:{method:i}}),d=o.getPaymentMethodOrThrow(i,n),{loadingContainerId:l,buttonHeight:c,onComplete:u}=e;if(this._loadingIndicatorContainer=l,this._onComplete=u,!Z(d))throw new y(s.MissingPaymentMethod);const{initializationData:p}=d,{captureMethod:m}=p,g=this.stripeIntegrationService.getStripeJsVersion(p);this._captureMethod=m,this._stripeClient=yield this.scriptLoader.getStripeClient(p,o.getCartLocale(),g),yield this._mountExpressCheckoutElement(r,this._stripeClient,c),this._initializeEvents(i)})}signIn(){return Promise.resolve()}signOut(){return Promise.resolve()}executePaymentMethodCheckout(){return Promise.resolve()}deinitialize(){return Promise.resolve()}_mountExpressCheckoutElement(t,e,i=40){return It(this,void 0,void 0,function*(){const n=this._shouldRequireShippingAddress(),r=Object.assign(Object.assign(Object.assign({shippingAddressRequired:n},n?{allowedShippingCountries:yield this._getAvailableCountries()}:{}),n?{shippingRates:[{id:"_",amount:0,displayName:"Pending rates"}]}:{}),{billingAddressRequired:!0,emailRequired:!0,phoneNumberRequired:!0,paymentMethods:{link:x.AUTO,applePay:x.NEVER,googlePay:x.NEVER,amazonPay:x.NEVER,paypal:x.NEVER,klarna:x.NEVER},buttonHeight:i}),{cartAmount:o}=this.paymentIntegrationService.getState().getCartOrThrow(),s=Object.assign({mode:"payment",amount:this._toCents(o),currency:this._getCurrency()},this._captureMethod?{captureMethod:this._captureMethod}:{});return this._stripeElements=e.elements(s),this._linkV2Element=this._stripeElements.create(j.EXPRESS_CHECKOUT,r),this._linkV2Element.mount(`#${t}`),this._linkV2Element})}_initializeEvents(t){this._linkV2Element&&(this._shouldRequireShippingAddress()&&(this._linkV2Element.on(F.SHIPPING_ADDRESS_CHANGE,t=>It(this,void 0,void 0,function*(){return this._onShippingAddressChange(t)})),this._linkV2Element.on(F.SHIPPING_RATE_CHANGE,t=>It(this,void 0,void 0,function*(){return this._onShippingRateChange(t)}))),this._linkV2Element.on(F.CONFIRM,e=>It(this,void 0,void 0,function*(){return this._onConfirm(e,t)})),this._linkV2Element.on(F.CANCEL,this._onCancel))}_onShippingAddressChange(t){return It(this,void 0,void 0,function*(){if(!("address"in t))return;const e=t.address,i={firstName:"",lastName:"",phone:"",company:"",address1:"",address2:"",city:(null==e?void 0:e.city)||"",countryCode:(null==e?void 0:e.country)||"",postalCode:(null==e?void 0:e.postal_code)||"",stateOrProvince:(null==e?void 0:e.state)||"",stateOrProvinceCode:(null==e?void 0:e.state)||"",customFields:[]};yield this.paymentIntegrationService.updateShippingAddress(i);const n=yield this._getAvailableShippingOptions();yield this._updateDisplayedPrice(),(null==n?void 0:n.length)?t.resolve({shippingRates:n}):t.reject()})}_onCancel(){throw new f}_onShippingRateChange(t){return It(this,void 0,void 0,function*(){if("shippingRate"in t){const{shippingRate:e}=t;yield this._handleShippingOptionChange(null==e?void 0:e.id),yield this._updateDisplayedPrice(),t.resolve({})}})}_onConfirm(t,e){return It(this,void 0,void 0,function*(){if("billingDetails"in t&&"shippingAddress"in t&&this._stripeClient&&this._stripeElements){yield this._updateShippingAndBillingAddress(t),yield this.paymentIntegrationService.submitOrder();const i=this._getPaymentPayload(e);try{yield this.paymentIntegrationService.submitPayment(i)}catch(t){yield this._processAdditionalAction(t,e)}}return Promise.resolve()})}_updateShippingAndBillingAddress(t){var e,i,n,r,o,s,a,d;return It(this,void 0,void 0,function*(){const l=this._shouldRequireShippingAddress(),c=(null===(i=null===(e=t.shippingAddress)||void 0===e?void 0:e.name)||void 0===i?void 0:i.split(" ")[0])||(null===(r=null===(n=t.billingDetails)||void 0===n?void 0:n.name)||void 0===r?void 0:r.split(" ")[0])||"",h=(null===(s=null===(o=t.shippingAddress)||void 0===o?void 0:o.name)||void 0===s?void 0:s.split(" ")[1])||(null===(d=null===(a=t.billingDetails)||void 0===a?void 0:a.name)||void 0===d?void 0:d.split(" ")[1])||"";if(l){const e=this._mapShippingAddress(t.shippingAddress,t.billingDetails,c,h);yield this.paymentIntegrationService.updateShippingAddress(e)}const u=this._mapBillingAddress(t.shippingAddress,t.billingDetails,c,h);yield this.paymentIntegrationService.updateBillingAddress(u)})}_mapShippingAddress(t,e,i,n){var r,o,s,a,d,l,c;return{firstName:i,lastName:n,phone:(null==e?void 0:e.phone)||"",company:"",address1:(null===(r=null==t?void 0:t.address)||void 0===r?void 0:r.line1)||"",address2:(null===(o=null==t?void 0:t.address)||void 0===o?void 0:o.line2)||"",city:(null===(s=null==t?void 0:t.address)||void 0===s?void 0:s.city)||"",countryCode:(null===(a=null==t?void 0:t.address)||void 0===a?void 0:a.country)||"",postalCode:(null===(d=null==t?void 0:t.address)||void 0===d?void 0:d.postal_code)||"",stateOrProvince:(null===(l=null==t?void 0:t.address)||void 0===l?void 0:l.state)||"",stateOrProvinceCode:(null===(c=null==t?void 0:t.address)||void 0===c?void 0:c.state)||"",customFields:[]}}_mapBillingAddress(t,e,i,n){var r,o,s,a,d,l;return{email:(null==e?void 0:e.email)||"",firstName:i,lastName:n,phone:(null==e?void 0:e.phone)||"",company:"",address1:(null===(r=null==e?void 0:e.address)||void 0===r?void 0:r.line1)||"",address2:"",city:(null===(o=null==e?void 0:e.address)||void 0===o?void 0:o.city)||"",countryCode:(null===(s=null==e?void 0:e.address)||void 0===s?void 0:s.country)||"",postalCode:(null===(a=null==e?void 0:e.address)||void 0===a?void 0:a.postal_code)||"",stateOrProvince:(null===(d=null==e?void 0:e.address)||void 0===d?void 0:d.state)||"",stateOrProvinceCode:(null===(l=null==t?void 0:t.address)||void 0===l?void 0:l.state)||"",customFields:[]}}_processAdditionalAction(t,e){return It(this,void 0,void 0,function*(){if(!S(t)||!this.stripeIntegrationService.isAdditionalActionError(t.body.errors))throw t;if(!this._stripeClient||!this._stripeElements)throw new v(a.PaymentNotInitialized);const{data:i}=t.body.additional_action_required,{token:n}=i,{paymentIntent:r}=yield this._confirmStripePaymentOrThrow(i,e),o=this._getPaymentPayload(e,(null==r?void 0:r.id)||n);try{this._toggleLoadingIndicator(!0),yield this.paymentIntegrationService.submitPayment(o),yield this._completeCheckoutFlow()}catch(t){this.stripeIntegrationService.throwPaymentConfirmationProceedMessage()}finally{this._toggleLoadingIndicator(!1)}})}_confirmStripePaymentOrThrow(t,e){var i,n,r;return It(this,void 0,void 0,function*(){const{token:o,redirect_url:s}=t,a=this.stripeIntegrationService.mapStripePaymentData(this._stripeElements,s);let d;try{const t=(yield this.stripeIntegrationService.isPaymentCompleted(e,this._stripeClient))?yield null===(r=this._stripeClient)||void 0===r?void 0:r.retrievePaymentIntent(o||""):yield null===(i=this._stripeClient)||void 0===i?void 0:i.confirmPayment({elements:a.elements,clientSecret:o,redirect:x.IF_REQUIRED,confirmParams:{return_url:null===(n=a.confirmParams)||void 0===n?void 0:n.return_url}});if(d=null==t?void 0:t.error,d||!(null==t?void 0:t.paymentIntent))throw new W;return t}catch(t){return this.stripeIntegrationService.throwStripeError(d)}})}_completeCheckoutFlow(){return It(this,void 0,void 0,function*(){return"function"==typeof this._onComplete?this._onComplete():(window.location.replace("/order-confirmation"),Promise.resolve())})}_getPaymentPayload(t,e){var i;const n=(null===(i=this.paymentIntegrationService.getState().getCart())||void 0===i?void 0:i.id)||"";return{methodId:t,paymentData:{formattedPayload:Object.assign(Object.assign({cart_id:n},e?{credit_card_token:{token:e}}:{}),{confirm:!1,method:U.Link})}}}_shouldRequireShippingAddress(){const{getCartOrThrow:t}=this.paymentIntegrationService.getState(),{lineItems:e}=t();return!!e.physicalItems.length}_updateDisplayedPrice(){return It(this,void 0,void 0,function*(){this._stripeElements&&this._stripeElements.update({currency:this._getCurrency(),mode:"payment",amount:yield this._getTotalPrice()})})}_getCurrency(){if(!this._currencyCode){const{code:t}=this.paymentIntegrationService.getState().getCartOrThrow().currency;this._currencyCode=t.toLowerCase()}return this._currencyCode}_getTotalPrice(){return It(this,void 0,void 0,function*(){yield this.paymentIntegrationService.loadCheckout();const{getCheckoutOrThrow:t,getCartOrThrow:e}=this.paymentIntegrationService.getState(),{decimalPlaces:i}=e().currency,n=r(t().outstandingBalance,i).toFixed(i);return this._toCents(+n)})}_getAvailableCountries(){var t;return It(this,void 0,void 0,function*(){const e=yield this.paymentIntegrationService.loadShippingCountries();return((null===(t=e.getShippingCountries())||void 0===t?void 0:t.map(t=>t.code))||[]).filter(t=>_t.includes(t))})}_getAvailableShippingOptions(){var t,e,i;return It(this,void 0,void 0,function*(){const n=this.paymentIntegrationService.getState().getConsignments();if(!(null==n?void 0:n[0]))return;const r=n[0],o=(r.availableShippingOptions||[]).map(this._getStripeShippingOption.bind(this)),s=null===(t=r.availableShippingOptions)||void 0===t?void 0:t.find(t=>t.isRecommended),a=null===(e=r.selectedShippingOption)||void 0===e?void 0:e.id,d=null==s?void 0:s.id;return a?o.sort(t=>t.id===a?-1:0):d?(o.sort(t=>t.id===d?-1:0),yield this._handleShippingOptionChange(d)):yield this._handleShippingOptionChange(null===(i=o[0])||void 0===i?void 0:i.id),o})}_getStripeShippingOption({id:t,cost:e,description:i}){return{id:t,displayName:i,amount:this._toCents(e)}}_handleShippingOptionChange(t){return It(this,void 0,void 0,function*(){if(t&&"shipping_option_unselected"!==t)return this.paymentIntegrationService.selectShippingOption(t)})}_getAmountTransformer(){if(this._amountTransformer)return this._amountTransformer;const{getCart:t}=this.paymentIntegrationService.getState(),{currency:e}=t()||{};return e?new ft(e.decimalPlaces):void 0}_toCents(t){const e=Math.round(100*t),i=this._getAmountTransformer();return i?i.toInteger(t):e}_toggleLoadingIndicator(t){t&&this._loadingIndicatorContainer?this.loadingIndicator.show(this._loadingIndicatorContainer):this.loadingIndicator.hide()}}const Et=l(e=>{const i=new q(t()),n=new St({containerStyles:gt});return new Ct(e,i,new $(e,i),n)},[{id:"stripeocs"}]);var Pt=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{d(n.next(t))}catch(t){o(t)}}function a(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,a)}d((n=n.apply(t,e||[])).next())})};class bt{constructor(t,e,i,n){this.paymentIntegrationService=t,this.scriptLoader=e,this.stripeIntegrationService=i,this.loadingIndicator=n}initialize(t){return Pt(this,void 0,void 0,function*(){const{stripeocs:e,containerId:i}=t||{};if(!e||!i)throw new v(a.PaymentNotInitialized);const{methodId:n,gatewayId:r}=e;if(!n||!r)throw new y(s.MissingPaymentMethod);const o=yield this.paymentIntegrationService.loadPaymentMethod(r,{params:{method:n}}),d=o.getPaymentMethodOrThrow(n,r),{loadingContainerId:l,buttonHeight:c,onComplete:h}=e;if(this._loadingIndicatorContainer=l,this._onComplete=h,!Z(d))throw new y(s.MissingPaymentMethod);const{initializationData:u}=d,{captureMethod:p}=u,m=this.stripeIntegrationService.getStripeJsVersion(u);this._captureMethod=p,this._stripeClient=yield this.scriptLoader.getStripeClient(u,o.getCartLocale(),m),yield this.paymentIntegrationService.loadDefaultCheckout(),yield this._mountExpressCheckoutElement(i,this._stripeClient,c),this._initializeEvents(n)})}signIn(){return Promise.resolve()}signOut(){return Promise.resolve()}executePaymentMethodCheckout(){return Promise.resolve()}deinitialize(){return Promise.resolve()}_mountExpressCheckoutElement(t,e,i=40){return Pt(this,void 0,void 0,function*(){const n=this._shouldRequireShippingAddress(),r=Object.assign(Object.assign(Object.assign({shippingAddressRequired:n},n?{allowedShippingCountries:yield this._getAvailableCountries()}:{}),n?{shippingRates:[{id:"_",amount:0,displayName:"Pending rates"}]}:{}),{billingAddressRequired:!0,emailRequired:!0,phoneNumberRequired:!0,paymentMethods:{link:x.AUTO,applePay:x.NEVER,googlePay:x.NEVER,amazonPay:x.NEVER,paypal:x.NEVER,klarna:x.NEVER},buttonHeight:i}),{cartAmount:o=1}=this.paymentIntegrationService.getState().getCart()||{},s=Object.assign({mode:"payment",amount:this._toCents(o),currency:this._getCurrency()},this._captureMethod?{captureMethod:this._captureMethod}:{});this._stripeElements=e.elements(s),this._linkV2Element=this._stripeElements.create(j.EXPRESS_CHECKOUT,r),this._linkV2Element.mount(`#${t}`)})}_initializeEvents(t){this._linkV2Element&&(this._shouldRequireShippingAddress()&&(this._linkV2Element.on(F.SHIPPING_ADDRESS_CHANGE,t=>Pt(this,void 0,void 0,function*(){return this._onShippingAddressChange(t)})),this._linkV2Element.on(F.SHIPPING_RATE_CHANGE,t=>Pt(this,void 0,void 0,function*(){return this._onShippingRateChange(t)}))),this._linkV2Element.on(F.CONFIRM,e=>Pt(this,void 0,void 0,function*(){return this._onConfirm(e,t)})),this._linkV2Element.on(F.CANCEL,this._onCancel))}_onShippingAddressChange(t){return Pt(this,void 0,void 0,function*(){if(!("address"in t))return;const e=t.address,i={firstName:"",lastName:"",phone:"",company:"",address1:"",address2:"",city:(null==e?void 0:e.city)||"",countryCode:(null==e?void 0:e.country)||"",postalCode:(null==e?void 0:e.postal_code)||"",stateOrProvince:(null==e?void 0:e.state)||"",stateOrProvinceCode:(null==e?void 0:e.state)||"",customFields:[]};yield this.paymentIntegrationService.updateShippingAddress(i);const n=yield this._getAvailableShippingOptions();yield this._updateDisplayedPrice(),(null==n?void 0:n.length)?t.resolve({shippingRates:n}):t.reject()})}_onCancel(){throw new f}_onShippingRateChange(t){return Pt(this,void 0,void 0,function*(){if("shippingRate"in t){const{shippingRate:e}=t;yield this._handleShippingOptionChange(null==e?void 0:e.id),yield this._updateDisplayedPrice(),t.resolve({})}})}_onConfirm(t,e){return Pt(this,void 0,void 0,function*(){if("billingDetails"in t&&"shippingAddress"in t&&this._stripeClient&&this._stripeElements){yield this._updateShippingAndBillingAddress(t),yield this.paymentIntegrationService.submitOrder();const i=this._getPaymentPayload(e);try{yield this.paymentIntegrationService.submitPayment(i)}catch(t){yield this._processAdditionalAction(t,e)}}return Promise.resolve()})}_updateShippingAndBillingAddress(t){var e,i,n,r,o,s,a,d;return Pt(this,void 0,void 0,function*(){const l=this._shouldRequireShippingAddress(),c=(null===(i=null===(e=t.shippingAddress)||void 0===e?void 0:e.name)||void 0===i?void 0:i.split(" ")[0])||(null===(r=null===(n=t.billingDetails)||void 0===n?void 0:n.name)||void 0===r?void 0:r.split(" ")[0])||"",h=(null===(s=null===(o=t.shippingAddress)||void 0===o?void 0:o.name)||void 0===s?void 0:s.split(" ")[1])||(null===(d=null===(a=t.billingDetails)||void 0===a?void 0:a.name)||void 0===d?void 0:d.split(" ")[1])||"";if(l){const e=this._mapShippingAddress(t.shippingAddress,t.billingDetails,c,h);yield this.paymentIntegrationService.updateShippingAddress(e)}const u=this._mapBillingAddress(t.shippingAddress,t.billingDetails,c,h);yield this.paymentIntegrationService.updateBillingAddress(u)})}_mapShippingAddress(t,e,i,n){var r,o,s,a,d,l,c;return{firstName:i,lastName:n,phone:(null==e?void 0:e.phone)||"",company:"",address1:(null===(r=null==t?void 0:t.address)||void 0===r?void 0:r.line1)||"",address2:(null===(o=null==t?void 0:t.address)||void 0===o?void 0:o.line2)||"",city:(null===(s=null==t?void 0:t.address)||void 0===s?void 0:s.city)||"",countryCode:(null===(a=null==t?void 0:t.address)||void 0===a?void 0:a.country)||"",postalCode:(null===(d=null==t?void 0:t.address)||void 0===d?void 0:d.postal_code)||"",stateOrProvince:(null===(l=null==t?void 0:t.address)||void 0===l?void 0:l.state)||"",stateOrProvinceCode:(null===(c=null==t?void 0:t.address)||void 0===c?void 0:c.state)||"",customFields:[]}}_mapBillingAddress(t,e,i,n){var r,o,s,a,d,l;return{email:(null==e?void 0:e.email)||"",firstName:i,lastName:n,phone:(null==e?void 0:e.phone)||"",company:"",address1:(null===(r=null==e?void 0:e.address)||void 0===r?void 0:r.line1)||"",address2:"",city:(null===(o=null==e?void 0:e.address)||void 0===o?void 0:o.city)||"",countryCode:(null===(s=null==e?void 0:e.address)||void 0===s?void 0:s.country)||"",postalCode:(null===(a=null==e?void 0:e.address)||void 0===a?void 0:a.postal_code)||"",stateOrProvince:(null===(d=null==e?void 0:e.address)||void 0===d?void 0:d.state)||"",stateOrProvinceCode:(null===(l=null==t?void 0:t.address)||void 0===l?void 0:l.state)||"",customFields:[]}}_processAdditionalAction(t,e){return Pt(this,void 0,void 0,function*(){if(!S(t)||!this.stripeIntegrationService.isAdditionalActionError(t.body.errors))throw t;if(!this._stripeClient||!this._stripeElements)throw new v(a.PaymentNotInitialized);const{data:i}=t.body.additional_action_required,{token:n}=i,{paymentIntent:r}=yield this._confirmStripePaymentOrThrow(i,e),o=this._getPaymentPayload(e,(null==r?void 0:r.id)||n);try{this._toggleLoadingIndicator(!0),yield this.paymentIntegrationService.submitPayment(o),yield this._completeCheckoutFlow()}catch(t){this.stripeIntegrationService.throwPaymentConfirmationProceedMessage()}finally{this._toggleLoadingIndicator(!1)}})}_confirmStripePaymentOrThrow(t,e){var i,n,r;return Pt(this,void 0,void 0,function*(){const{token:o,redirect_url:s}=t,a=this.stripeIntegrationService.mapStripePaymentData(this._stripeElements,s);let d;try{const t=(yield this.stripeIntegrationService.isPaymentCompleted(e,this._stripeClient))?yield null===(r=this._stripeClient)||void 0===r?void 0:r.retrievePaymentIntent(o||""):yield null===(i=this._stripeClient)||void 0===i?void 0:i.confirmPayment({elements:a.elements,clientSecret:o,redirect:x.IF_REQUIRED,confirmParams:{return_url:null===(n=a.confirmParams)||void 0===n?void 0:n.return_url}});if(d=null==t?void 0:t.error,d||!(null==t?void 0:t.paymentIntent))throw new W;return t}catch(t){return this.stripeIntegrationService.throwStripeError(d)}})}_completeCheckoutFlow(){return Pt(this,void 0,void 0,function*(){return"function"==typeof this._onComplete?this._onComplete():(window.location.replace("/checkout/order-confirmation"),Promise.resolve())})}_getPaymentPayload(t,e){var i;const n=(null===(i=this.paymentIntegrationService.getState().getCart())||void 0===i?void 0:i.id)||"";return{methodId:t,paymentData:{formattedPayload:Object.assign(Object.assign({cart_id:n},e?{credit_card_token:{token:e}}:{}),{confirm:!1,method:U.Link})}}}_shouldRequireShippingAddress(){const{getCart:t}=this.paymentIntegrationService.getState(),{lineItems:e}=t()||{};return!!(null==e?void 0:e.physicalItems.length)}_updateDisplayedPrice(){return Pt(this,void 0,void 0,function*(){this._stripeElements&&this._stripeElements.update({currency:this._getCurrency(),mode:"payment",amount:yield this._getTotalPrice()})})}_getCurrency(){var t;if(!this._currencyCode){const e=null===(t=this.paymentIntegrationService.getState().getCart())||void 0===t?void 0:t.currency;e&&(this._currencyCode=e.code.toLowerCase())}return this._currencyCode}_getTotalPrice(){var t;return Pt(this,void 0,void 0,function*(){yield this.paymentIntegrationService.loadCheckout();const{getCheckoutOrThrow:e,getCart:i}=this.paymentIntegrationService.getState(),{decimalPlaces:n}=(null===(t=i())||void 0===t?void 0:t.currency)||{},o=r(e().outstandingBalance,n).toFixed(n);return this._toCents(+o)})}_getAvailableCountries(){var t;return Pt(this,void 0,void 0,function*(){const e=yield this.paymentIntegrationService.loadShippingCountries();return((null===(t=e.getShippingCountries())||void 0===t?void 0:t.map(t=>t.code))||[]).filter(t=>_t.includes(t))})}_getAvailableShippingOptions(){var t,e,i;return Pt(this,void 0,void 0,function*(){const n=this.paymentIntegrationService.getState().getConsignments();if(!(null==n?void 0:n[0]))return;const r=n[0],o=(r.availableShippingOptions||[]).map(this._getStripeShippingOption.bind(this)),s=null===(t=r.availableShippingOptions)||void 0===t?void 0:t.find(t=>t.isRecommended),a=null===(e=r.selectedShippingOption)||void 0===e?void 0:e.id,d=null==s?void 0:s.id;return a?o.sort(t=>t.id===a?-1:0):d?(o.sort(t=>t.id===d?-1:0),yield this._handleShippingOptionChange(d)):yield this._handleShippingOptionChange(null===(i=o[0])||void 0===i?void 0:i.id),o})}_getStripeShippingOption({id:t,cost:e,description:i}){return{id:t,displayName:i,amount:this._toCents(e)}}_handleShippingOptionChange(t){return Pt(this,void 0,void 0,function*(){if(t&&"shipping_option_unselected"!==t)return this.paymentIntegrationService.selectShippingOption(t)})}_getAmountTransformer(){if(this._amountTransformer)return this._amountTransformer;const{getCart:t}=this.paymentIntegrationService.getState(),{currency:e}=t()||{};return e?new ft(e.decimalPlaces):void 0}_toCents(t){const e=Math.round(100*t),i=this._getAmountTransformer();return i?i.toInteger(t):e}_toggleLoadingIndicator(t){t&&this._loadingIndicatorContainer?this.loadingIndicator.show(this._loadingIndicatorContainer):this.loadingIndicator.hide()}}const wt=l(e=>{const i=new q(t()),n=new St({containerStyles:gt});return new bt(e,i,new $(e,i),n)},[{id:"stripeocs"}]);export{wt as createLinkV2ButtonStrategy,ut as createStripeCSPaymentStrategy,Et as createStripeLinkV2CustomerStrategy,lt as createStripeOCSPaymentStrategy,mt as createStripeUPECustomerStrategy,ot as createStripeUPEPaymentStrategy,T as createStripeV3PaymentStrategy};
//# sourceMappingURL=stripe.js.map